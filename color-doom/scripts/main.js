"use strict";window.DOMHandler=class{constructor(e,t){this._iRuntime=e,this._componentId=t,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(e,t,n,o){this._iRuntime.PostToRuntimeComponent(this._componentId,e,t,n,o)}PostToRuntimeAsync(e,t,n,o){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,e,t,n,o)}_PostToRuntimeMaybeSync(e,t,n){this._iRuntime.UsesWorker()?this.PostToRuntime(e,t,n):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:e,dispatchOpts:n||null,data:t,responseId:null})}AddRuntimeMessageHandler(e,t){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,e,t)}AddRuntimeMessageHandlers(e){for(const[t,n]of e)this.AddRuntimeMessageHandler(t,n)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},"use strict",window.DOMElementHandler=class extends DOMHandler{constructor(e,t){super(e,t),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandler("create",e=>this._OnCreate(e)),this.AddRuntimeMessageHandler("destroy",e=>this._OnDestroy(e)),this.AddRuntimeMessageHandler("set-visible",e=>this._OnSetVisible(e)),this.AddRuntimeMessageHandler("update-position",e=>this._OnUpdatePosition(e)),this.AddRuntimeMessageHandler("update-state",e=>this._OnUpdateState(e)),this.AddRuntimeMessageHandler("focus",e=>this._OnSetFocus(e)),this.AddRuntimeMessageHandler("set-css-style",e=>this._OnSetCssStyle(e))}SetAutoAttach(e){this._autoAttach=!!e}AddDOMElementMessageHandler(e,t){this.AddRuntimeMessageHandler(e,e=>{const n=e.elementId,o=this._elementMap.get(n);return t(o,e)})}_OnCreate(e){const t=e.elementId,n=this.CreateElement(t,e);this._elementMap.set(t,n),e.isVisible||(n.style.display="none"),this._autoAttach&&document.body.appendChild(n)}CreateElement(){throw new Error("required override")}DestroyElement(){}_OnDestroy(e){const t=e.elementId,n=this._elementMap.get(t);this.DestroyElement(n),this._autoAttach&&n.parentElement.removeChild(n),this._elementMap.delete(t)}PostToRuntimeElement(e,t,n){n||(n={}),n.elementId=t,this.PostToRuntime(e,n)}_PostToRuntimeElementMaybeSync(e,t,n){n||(n={}),n.elementId=t,this._PostToRuntimeMaybeSync(e,n)}_OnSetVisible(e){if(this._autoAttach){const t=this._elementMap.get(e.elementId);t.style.display=e.isVisible?"":"none"}}_OnUpdatePosition(e){if(this._autoAttach){const t=this._elementMap.get(e.elementId);t.style.left=e.left+"px",t.style.top=e.top+"px",t.style.width=e.width+"px",t.style.height=e.height+"px";const n=e.fontSize;null!==n&&(t.style.fontSize=n+"em")}}_OnUpdateState(e){const t=this._elementMap.get(e.elementId);this.UpdateState(t,e)}UpdateState(){throw new Error("required override")}_OnSetFocus(e){const t=this._elementMap.get(e.elementId);e.focus?t.focus():t.blur()}_OnSetCssStyle(e){const t=this._elementMap.get(e.elementId);t.style[e.prop]=e.val}GetElementById(e){return this._elementMap.get(e)}},"use strict";{function t(e){return new Promise((t,n)=>{const o=document.createElement("script");o.onload=t,o.onerror=n,o.async=!1,o.src=e,document.head.appendChild(o)})}async function n(e){const t=await o(e),n=new TextDecoder("utf-8");return n.decode(t)}function o(e){return new Promise((t,n)=>{const o=new FileReader;o.onload=e=>t(e.target.result),o.onerror=e=>n(e),o.readAsArrayBuffer(e)})}const a=/(iphone|ipod|ipad)/i.test(navigator.userAgent);let d=new Audio;const r={"audio/webm; codecs=opus":!!d.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!d.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!d.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!d.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!d.canPlayType("audio/mp4"),"audio/mpeg":!!d.canPlayType("audio/mpeg")};d=null;const e=[];let s=0;window.RealFile=window.File;const u=[],i=new Map,_=new Map;let p=0;const l=[];self.runOnStartup=function(e){if("function"!=typeof e)throw new Error("runOnStartup called without a function");l.push(e)},window.RuntimeInterface=class d{constructor(e){this._useWorker=e.useWorker,this._messageChannelPort=null,this._baseUrl="",this._scriptFolder=e.scriptFolder,this._workerScriptBlobURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._exportType=e.exportType,"cordova"===this._exportType&&this._useWorker&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in Cordova due to crbug.com/939775. Reverting to DOM mode."),this._useWorker=!1),/CrOS/.test(navigator.userAgent)&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in Chrome OS due to reports of crashes. Reverting to DOM mode."),this._useWorker=!1),this._transferablesBroken=!1,this._localFileBlobs=null,("html5"===this._exportType||"playable-ad"===this._exportType)&&"file"===location.protocol.substr(0,4)&&alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)"),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",e=>this._OnCordovaFetchLocalFile(e)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",e=>this._OnCreateJobWorker(e)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(e)):this._Init(e)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetBaseURL(){return this._baseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsWKWebView(){return"cordova"===this._exportType&&a}IsAndroid(){return"cordova"===this._exportType&&!1===a}async _Init(e){if("playable-ad"===this._exportType){this._localFileBlobs=self.c3_base64files,await this._ConvertDataUrisToBlobs();for(let t=0,n=e.engineScripts.length;t<n;++t){const n=e.engineScripts[t].toLowerCase();this._localFileBlobs.hasOwnProperty(n)&&(e.engineScripts[t]=URL.createObjectURL(this._localFileBlobs[n]))}}if(e.baseUrl)this._baseUrl=e.baseUrl;else{const e=location.origin;this._baseUrl=("null"===e?"file:///":e)+location.pathname;const t=this._baseUrl.lastIndexOf("/");-1!==t&&(this._baseUrl=this._baseUrl.substr(0,t+1))}if(e.workerScripts)for(const[t,n]of Object.entries(e.workerScripts))this._workerScriptBlobURLs[t]=URL.createObjectURL(n);const t=new MessageChannel;this._messageChannelPort=t.port1,this._messageChannelPort.onmessage=e=>this._OnMessageFromRuntime(e.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(e=>this._OnMessageFromDebugger(e)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),this.MaybeForceBodySize(),"object"==typeof window.StatusBar&&window.StatusBar.hide(),"object"==typeof window.AndroidFullScreen&&window.AndroidFullScreen.immersiveMode(),await this._TestTransferablesWork(),this._useWorker?await this._InitWorker(e,t.port2):await this._InitDOM(e,t.port2)}_GetWorkerURL(e){return this._workerScriptBlobURLs.hasOwnProperty(e)?this._workerScriptBlobURLs[e]:e.endsWith("/workermain.js")&&this._workerScriptBlobURLs.hasOwnProperty("workermain.js")?this._workerScriptBlobURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(e.toLowerCase())?URL.createObjectURL(this._localFileBlobs[e.toLowerCase()]):e}async CreateWorker(t,n,o){if(t.startsWith("blob:"))return new Worker(t,o);if(this.IsWKWebView()){const e=await this.CordovaFetchLocalFileAsArrayBuffer(this._scriptFolder+t),n=new Blob([e],{type:"application/javascript"});return new Worker(URL.createObjectURL(n),o)}const i=new URL(t,n),a=location.origin!==i.origin;if(a){const e=await fetch(i);if(!e.ok)throw new Error("failed to fetch worker script");const t=await e.blob();return new Worker(URL.createObjectURL(t),o)}return new Worker(i,o)}MaybeForceBodySize(){if(this.IsWKWebView()){const t=document.documentElement.style,n=document.body.style,o=window.innerWidth<window.innerHeight,a=o?window.screen.width:window.screen.height,i=o?window.screen.height:window.screen.width;n.height=t.height=i+"px",n.width=t.width=a+"px"}}_GetCommonRuntimeOptions(e){return{baseUrl:this._baseUrl,windowInnerWidth:window.innerWidth,windowInnerHeight:window.innerHeight,devicePixelRatio:window.devicePixelRatio,isFullscreen:d.IsDocumentFullscreen(),projectData:e.projectData,previewImageBlobs:window.cr_previewImageBlobs||this._localFileBlobs,previewProjectFileBlobs:window.cr_previewProjectFileBlobs,exportType:e.exportType,isDebug:-1<self.location.search.indexOf("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:r,opusWasmScriptUrl:window.cr_opusWasmScriptUrl||this._scriptFolder+"opus.wasm.js",opusWasmBinaryUrl:window.cr_opusWasmBinaryUrl||this._scriptFolder+"opus.wasm.wasm",isWKWebView:this.IsWKWebView(),isFBInstantAvailable:"undefined"!=typeof self.FBInstant}}async _InitWorker(e,t){const n=this._GetWorkerURL(e.workerMainUrl);this._worker=await this.CreateWorker(n,this._baseUrl,{name:"Runtime"}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const o=this._canvas.transferControlToOffscreen();document.body.appendChild(this._canvas),window.c3canvas=this._canvas,this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(e),{type:"init-runtime",isInWorker:!0,messagePort:t,canvas:o,workerDependencyScripts:e.workerDependencyScripts||[],engineScripts:e.engineScripts,projectScripts:window.cr_allProjectScripts,projectScriptsStatus:self.C3_ProjectScriptsStatus}),[t,o,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=u.map(e=>new e(this)),this._FindRuntimeDOMHandler(),self.c3_callFunction=(e,t)=>this._runtimeDomHandler._InvokeFunctionFromJS(e,t),"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(n,o){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window.c3canvas=this._canvas,this._domHandlers=u.map(e=>new e(this)),this._FindRuntimeDOMHandler();const a=n.engineScripts.map(e=>new URL(e,this._baseUrl).toString());if(Array.isArray(n.workerDependencyScripts)&&a.unshift(...n.workerDependencyScripts),await Promise.all(a.map(e=>t(e))),n.projectScripts&&0<n.projectScripts.length){const e=self.C3_ProjectScriptsStatus;try{if(await Promise.all(n.projectScripts.map(e=>t(e[1]))),Object.values(e).some(e=>!e))return void self.setTimeout(()=>this._ReportProjectScriptError(e),100)}catch(t){return console.error("[Preview] Error loading project scripts: ",t),void self.setTimeout(()=>this._ReportProjectScriptError(e),100)}}if("preview"===this._exportType&&"object"!=typeof self.C3.ScriptsInEvents)return console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),void alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.");const i=Object.assign(this._GetCommonRuntimeOptions(n),{isInWorker:!1,messagePort:o,canvas:this._canvas,runOnStartupFunctions:l});this._localRuntime=self.C3_CreateRuntime(i),await self.C3_InitRuntime(this._localRuntime,i)}_ReportProjectScriptError(e){const t=Object.entries(e).filter(e=>!e[1]).map(e=>e[0]),n=`Failed to load project script '${t[0]}'. Check all your JavaScript code has valid syntax.`;console.error("[Preview] "+n),alert(n)}async _OnCreateJobWorker(){const e=await this._jobScheduler._CreateJobWorker();return{outputPort:e,transferables:[e]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(t,n,o,a,i){this._messageChannelPort.postMessage({type:"event",component:t,handler:n,dispatchOpts:a||null,data:o,responseId:null},this._transferablesBroken?void 0:i)}PostToRuntimeComponentAsync(t,n,o,a,i){const e=p++,d=new Promise((t,n)=>{_.set(e,{resolve:t,reject:n})});return this._messageChannelPort.postMessage({type:"event",component:t,handler:n,dispatchOpts:a||null,data:o,responseId:e},this._transferablesBroken?void 0:i),d}["_OnMessageFromRuntime"](e){const t=e.type;if("event"===t)this._OnEventFromRuntime(e);else if("result"===t)this._OnResultFromRuntime(e);else if("runtime-ready"===t)this._OnRuntimeReady();else if("alert"===t)alert(e.message);else throw new Error(`unknown message '${t}'`)}_OnEventFromRuntime(t){const n=t.component,o=t.handler,a=t.data,d=t.responseId,e=i.get(n);if(!e)return void console.warn(`[DOM] No event handlers for component '${n}'`);const r=e.get(o);if(!r)return void console.warn(`[DOM] No handler '${o}' for component '${n}'`);let s=null;try{s=r(a)}catch(e){return console.error(`Exception in '${n}' handler '${o}':`,e),void(null!==d&&this._PostResultToRuntime(d,!1,e.toString()))}null!==d&&(s&&s.then?s.then(e=>this._PostResultToRuntime(d,!0,e)).catch(e=>{console.error(`Rejection from '${n}' handler '${o}':`,e),this._PostResultToRuntime(d,!1,e.toString())}):this._PostResultToRuntime(d,!0,s))}_PostResultToRuntime(e,t,n){let o;n&&n.transferables&&(o=n.transferables),this._messageChannelPort.postMessage({type:"result",responseId:e,isOk:t,result:n},o)}_OnResultFromRuntime(t){const n=t.responseId,o=t.isOk,a=t.result,i=_.get(n);o?i.resolve(a):i.reject(a),_.delete(n)}AddRuntimeComponentMessageHandler(e,t,n){let o=i.get(e);if(o||(o=new Map,i.set(e,o)),o.has(t))throw new Error(`[DOM] Component '${e}' already has handler '${t}'`);o.set(t,n)}static AddDOMHandlerClass(e){if(u.includes(e))throw new Error("DOM handler already added");u.push(e)}_FindRuntimeDOMHandler(){for(const e of this._domHandlers)if("runtime"===e.GetComponentID())return void(this._runtimeDomHandler=e);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(e){this.PostToRuntimeComponent("debugger","message",e)}_OnRuntimeReady(){for(const e of this._domHandlers)e.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement)}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(e){this._rafCallbacks.push(e),this._RequestAnimationFrame()}_RemoveRAFCallback(e){const t=this._rafCallbacks.indexOf(e);if(-1===t)throw new Error("invalid callback");this._rafCallbacks.splice(t,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const e of this._rafCallbacks)e();this._RequestAnimationFrame()}TryPlayMedia(e){this._runtimeDomHandler.TryPlayMedia(e)}RemovePendingPlay(e){this._runtimeDomHandler.RemovePendingPlay(e)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(e){this._runtimeDomHandler.SetSilent(e)}IsAudioFormatSupported(e){return!!r[e]}async _WasmDecodeWebMOpus(e){const t=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{arrayBuffer:e},null,[e]);return new Float32Array(t)}IsAbsoluteURL(e){return /^(?:[a-z]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)}IsRelativeURL(e){return!this.IsAbsoluteURL(e)}async _OnCordovaFetchLocalFile(e){const t=e.filename;switch(e.as){case"text":return await this.CordovaFetchLocalFileAsText(t);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(t);default:throw new Error("unsupported type");}}CordovaFetchLocalFile(e){const t=window.cordova.file.applicationDirectory+"www/"+e.toLowerCase();return new Promise((e,n)=>{window.resolveLocalFileSystemURL(t,t=>{t.file(e,n)},n)})}async CordovaFetchLocalFileAsText(e){const t=await this.CordovaFetchLocalFile(e);return await n(t)}_CordovaMaybeStartNextArrayBufferRead(){if(e.length&&!(8<=s)){s++;const t=e.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(t.filename,t.successCallback,t.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(t){return new Promise((n,o)=>{e.push({filename:t,successCallback:e=>{s--,this._CordovaMaybeStartNextArrayBufferRead(),n(e)},errorCallback:e=>{s--,this._CordovaMaybeStartNextArrayBufferRead(),o(e)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(t,n,e){try{const a=await this.CordovaFetchLocalFile(t),i=await o(a);n(i)}catch(t){e(t)}}async _ConvertDataUrisToBlobs(){const e=[];for(const[t,n]of Object.entries(this._localFileBlobs))e.push(this._ConvertDataUriToBlobs(t,n));await Promise.all(e)}async _ConvertDataUriToBlobs(e,t){if("object"==typeof t)this._localFileBlobs[e]=new Blob([t.str],{type:t.type});else{const n=await fetch(t),o=await n.blob();this._localFileBlobs[e]=o}}_TestTransferablesWork(){let e=null;const t=new Promise(t=>e=t),n=new ArrayBuffer(1),o=new MessageChannel;return o.port2.onmessage=t=>{t.data&&t.data.arrayBuffer||(this._transferablesBroken=!0,console.warn("MessageChannel transfers determined to be broken. Disabling transferables.")),e()},o.port1.postMessage({arrayBuffer:n},[n]),t}}}{function t(e){return e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents||e.originalEvent&&e.originalEvent.sourceCapabilities&&e.originalEvent.sourceCapabilities.firesTouchEvents}function r(e){return new Promise((t,n)=>{const o=document.createElement("link");o.onload=()=>t(o),o.onerror=e=>n(e),o.rel="stylesheet",o.href=e,document.head.appendChild(o)})}function a(e){return new Promise((t,n)=>{const o=new Image;o.onload=()=>t(o),o.onerror=e=>n(e),o.src=e})}async function s(e){const t=URL.createObjectURL(e);try{return await a(t)}finally{URL.revokeObjectURL(t)}}function u(e){do{if(e.parentNode&&e.hasAttribute("contenteditable"))return!0;e=e.parentNode}while(e);return!1}function d(e){const t=e.target.tagName.toLowerCase();l.has(t)&&e.preventDefault()}function e(e){(e.metaKey||e.ctrlKey)&&e.preventDefault()}function _(){try{return window.parent&&window.parent.document.hasFocus()}catch(e){return!1}}const p=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),i={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},f={dispatchUserScriptEvent:!0},c={dispatchRuntimeEvent:!0},l=new Set(["canvas","body","html"]);self.C3_RasterSvgImage=async function(t,n,o){const a=document.createElement("canvas");a.width=n,a.height=o;const i=a.getContext("2d");return i.drawImage(t,0,0,n,o),a};let m=!1;document.addEventListener("pause",()=>m=!0),document.addEventListener("resume",()=>m=!1);const n=class extends DOMHandler{constructor(t){super(t,"runtime"),this._isFirstSizeUpdate=!0,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._debugHighlightElem=null,t.AddRuntimeComponentMessageHandler("canvas","update-size",e=>this._OnUpdateCanvasSize(e)),t.AddRuntimeComponentMessageHandler("runtime","invoke-download",e=>this._OnInvokeDownload(e)),t.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",e=>this._OnRasterSvgImage(e)),t.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",e=>this._OnSetTargetOrientation(e)),t.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),t.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",e=>this._OnPostToDebugger(e)),t.AddRuntimeComponentMessageHandler("runtime","go-to-script",e=>this._OnPostToDebugger(e)),t.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),t.AddRuntimeComponentMessageHandler("runtime","debug-highlight",e=>this._OnDebugHighlight(e)),t.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),t.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),t.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",e=>this._OnAddStylesheet(e));const n=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",e=>{const t=e.target,o=t.tagName.toLowerCase();n.has(o)||u(t)||e.preventDefault()}),window.addEventListener("selectstart",d),window.addEventListener("gesturehold",d),window.addEventListener("touchstart",d,{passive:!1});const o=t.GetCanvas();"undefined"==typeof PointerEvent?o.addEventListener("touchstart",d):(window.addEventListener("pointerdown",d,{passive:!1}),o.addEventListener("pointerdown",d)),this._mousePointerLastButtons=0,window.addEventListener("mousedown",e=>{1===e.button&&e.preventDefault()}),window.addEventListener("mousewheel",e,{passive:!1}),window.addEventListener("wheel",e,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden)),document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1)),{isSuspended:!!(document.hidden||m)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:_()}),this._mousePointerLastButtons=0}),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("webkitfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("mozfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("keydown",e=>this._OnKeyEvent("keydown",e)),window.addEventListener("keyup",e=>this._OnKeyEvent("keyup",e)),window.addEventListener("dblclick",e=>this._OnMouseEvent("dblclick",e,i)),window.addEventListener("wheel",e=>this._OnMouseWheelEvent("wheel",e)),"undefined"==typeof PointerEvent?(window.addEventListener("mousedown",e=>this._OnMouseEventAsPointer("pointerdown",e)),window.addEventListener("mousemove",e=>this._OnMouseEventAsPointer("pointermove",e)),window.addEventListener("mouseup",e=>this._OnMouseEventAsPointer("pointerup",e)),window.addEventListener("touchstart",e=>this._OnTouchEvent("pointerdown",e)),window.addEventListener("touchmove",e=>this._OnTouchEvent("pointermove",e)),window.addEventListener("touchend",e=>this._OnTouchEvent("pointerup",e)),window.addEventListener("touchcancel",e=>this._OnTouchEvent("pointercancel",e))):(window.addEventListener("pointerdown",e=>this._OnPointerEvent("pointerdown",e)),window.addEventListener("pointermove",e=>this._OnPointerEvent("pointermove",e)),window.addEventListener("pointerup",e=>this._OnPointerEvent("pointerup",e)),window.addEventListener("pointercancel",e=>this._OnPointerEvent("pointercancel",e)));const e=()=>this._PlayPendingMedia();window.addEventListener("pointerup",e,!0),window.addEventListener("touchend",e,!0),window.addEventListener("click",e,!0),window.addEventListener("keydown",e,!0),window.addEventListener("gamepadconnected",e,!0)}_PostRuntimeEvent(e,t){this.PostToRuntime(e,t||null,c)}_OnWindowResize(){const e=window.innerWidth,t=window.innerHeight;this._PostRuntimeEvent("window-resize",{innerWidth:e,innerHeight:t,devicePixelRatio:window.devicePixelRatio}),this._iRuntime.IsWKWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(e,t,0))}_ScheduleSimulatedResize(e,t,n){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(e,t,n),48)}_OnSimulatedResize(t,n,o){const a=window.innerWidth,i=window.innerHeight;this._simulatedResizeTimerId=-1,a!=t||i!=n?this._PostRuntimeEvent("window-resize",{innerWidth:a,innerHeight:i,devicePixelRatio:window.devicePixelRatio}):10>o&&this._ScheduleSimulatedResize(a,i,o+1)}_OnSetTargetOrientation(e){this._targetOrientation=e.targetOrientation}_TrySetTargetOrientation(){const e=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(e).catch(e=>console.warn("[Construct 3] Failed to lock orientation: ",e));else try{let t=!1;screen.lockOrientation?t=screen.lockOrientation(e):screen.webkitLockOrientation?t=screen.webkitLockOrientation(e):screen.mozLockOrientation?t=screen.mozLockOrientation(e):screen.msLockOrientation&&(t=screen.msLockOrientation(e)),t||console.warn("[Construct 3] Failed to lock orientation")}catch(e){console.warn("[Construct 3] Failed to lock orientation: ",e)}}_OnFullscreenChange(){const e=RuntimeInterface.IsDocumentFullscreen();e&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:e,innerWidth:window.innerWidth,innerHeight:window.innerHeight})}_OnFullscreenError(e){console.warn("[Construct 3] Fullscreen request failed: ",e),this.PostToRuntime("fullscreenerror",{isFullscreen:RuntimeInterface.IsDocumentFullscreen(),innerWidth:window.innerWidth,innerHeight:window.innerHeight})}_OnVisibilityChange(e){e?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:e})}_OnKeyEvent(e,t){const n=p.get(t.code)||t.code;this._PostToRuntimeMaybeSync(e,{code:n,key:t.key,which:t.which,repeat:t.repeat,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp},i)}_OnMouseWheelEvent(e,t){this.PostToRuntime(e,{clientX:t.clientX,clientY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timeStamp:t.timeStamp},i)}_OnMouseEvent(e,n,o){t(n)||("mousedown"===e&&window!==window.top&&window.focus(),this._PostToRuntimeMaybeSync(e,{button:n.button,buttons:n.buttons,clientX:n.clientX,clientY:n.clientY,timeStamp:n.timeStamp},o))}_OnMouseEventAsPointer(e,n){if(!t(n)){"pointerdown"===e&&window!==window.top&&window.focus();const t=this._mousePointerLastButtons;"pointerdown"===e&&0!==t?e="pointermove":"pointerup"==e&&0!==n.buttons&&(e="pointermove"),this._PostToRuntimeMaybeSync(e,{pointerId:1,pointerType:"mouse",button:n.button,buttons:n.buttons,lastButtons:t,clientX:n.clientX,clientY:n.clientY,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,timeStamp:n.timeStamp},i),this._mousePointerLastButtons=n.buttons,this._OnMouseEvent(n.type,n,f)}}_OnPointerEvent(e,t){"pointerdown"===e&&window!==window.top&&window.focus();let n=0;if("mouse"===t.pointerType&&(n=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(e,{pointerId:t.pointerId,pointerType:t.pointerType,button:t.button,buttons:t.buttons,lastButtons:n,clientX:t.clientX,clientY:t.clientY,width:t.width||0,height:t.height||0,pressure:t.pressure||0,tangentialPressure:t.tangentialPressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,twist:t.twist||0,timeStamp:t.timeStamp},i),"mouse"===t.pointerType){let n="mousemove";"pointerdown"===e?n="mousedown":"pointerup"==e&&(n="pointerup"),this._OnMouseEvent(n,t,f),this._mousePointerLastButtons=t.buttons}}_OnTouchEvent(e,t){"pointerdown"===e&&window!==window.top&&window.focus();for(let n=0,o=t.changedTouches.length;n<o;++n){const o=t.changedTouches[n];this._PostToRuntimeMaybeSync(e,{pointerId:o.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:o.clientX,clientY:o.clientY,width:2*(o.radiusX||o.webkitRadiusX||0),height:2*(o.radiusY||o.webkitRadiusY||0),pressure:o.force||o.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:o.rotationAngle||0,timeStamp:t.timeStamp},i)}}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",e=>this._OnDeviceOrientation(e)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",e=>this._OnDeviceMotion(e)))}_OnDeviceOrientation(e){this.PostToRuntime("deviceorientation",{alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0,timeStamp:e.timeStamp},i)}_OnDeviceMotion(t){let n=null;const o=t.acceleration;o&&(n={x:o.x||0,y:o.y||0,z:o.z||0});let a=null;const r=t.accelerationIncludingGravity;r&&(a={x:r.x||0,y:r.y||0,z:r.z||0});let e=null;const s=t.rotationRate;s&&(e={alpha:s.alpha||0,beta:s.beta||0,gamma:s.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:n,accelerationIncludingGravity:a,rotationRate:e,interval:t.interval,timeStamp:t.timeStamp},i)}_OnUpdateCanvasSize(e){const t=this.GetRuntimeInterface(),n=t.GetCanvas();n.style.width=e.styleWidth+"px",n.style.height=e.styleHeight+"px",n.style.marginLeft=e.marginLeft+"px",n.style.marginTop=e.marginTop+"px",t.MaybeForceBodySize(),this._isFirstSizeUpdate&&(n.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(t){const n=t.url,o=t.filename,i=document.createElement("a"),e=document.body;i.textContent=o,i.href=n,i.download=o,e.appendChild(i),i.click(),e.removeChild(i)}async _OnRasterSvgImage(t){const n=t.blob,o=t.width,a=t.height,e=await s(n),i=await self.C3_RasterSvgImage(e,o,a);return await createImageBitmap(i)}async _OnAddStylesheet(e){await r(e.url)}_PlayPendingMedia(){const e=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const t of e){const e=t.play();e&&e.catch(()=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}}TryPlayMedia(e){if("function"!=typeof e.play)throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(e);let t;try{t=e.play()}catch(t){return void this._mediaPendingPlay.add(e)}t&&t.catch(()=>{this._mediaRemovedPendingPlay.has(e)||this._mediaPendingPlay.add(e)})}RemovePendingPlay(e){this._mediaPendingPlay.delete(e),this._mediaRemovedPendingPlay.add(e)}SetSilent(e){this._isSilent=!!e}_OnDebugHighlight(e){const t=e.show;if(!t)return void(this._debugHighlightElem&&(this._debugHighlightElem.style.display="none"));this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const n=this._debugHighlightElem;n.style.display="",n.style.left=e.left-1+"px",n.style.top=e.top-1+"px",n.style.width=e.width+2+"px",n.style.height=e.height+2+"px",n.textContent=e.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(e){window.c3_postToMessagePort&&(e.from="runtime",window.c3_postToMessagePort(e))}_InvokeFunctionFromJS(e,t){return this.PostToRuntimeAsync("js-invoke-function",{name:e,params:t})}};RuntimeInterface.AddDOMHandlerClass(n)}{const e=document.currentScript.src;self.JobSchedulerDOM=class{constructor(t){this._runtimeInterface=t,this._baseUrl=e?e.substr(0,e.lastIndexOf("/")+1):t.GetBaseURL(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface._GetWorkerURL("dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,this._baseUrl,{name:"DispatchWorker"});const t=new MessageChannel;this._inputPort=t.port1,this._dispatchWorker.postMessage({type:"_init","in-port":t.port2},[t.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const t=this._jobWorkers.length,n=this._runtimeInterface._GetWorkerURL("jobworker.js"),o=await this._runtimeInterface.CreateWorker(n,this._baseUrl,{name:"JobWorker"+t}),a=new MessageChannel,i=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:a.port1},[a.port1]),o.postMessage({type:"init",number:t,"dispatch-port":a.port2,"output-port":i.port2},[a.port2,i.port2]),this._jobWorkers.push(o),i.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}if("use strict",window.C3_IsSupported){const e="undefined"!=typeof OffscreenCanvas;window.c3_runtimeInterface=new RuntimeInterface({useWorker:e,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"})}{const e=class extends DOMHandler{constructor(e){super(e,"touch"),this.AddRuntimeMessageHandler("request-permission",e=>this._OnRequestPermission(e))}async _OnRequestPermission(e){const t=e.type;let n=!0;0===t?n=await this._RequestOrientationPermission():1===t&&(n=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:t,result:n})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{const e=await self.DeviceOrientationEvent.requestPermission();return"granted"===e}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{const e=await self.DeviceMotionEvent.requestPermission();return"granted"===e}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};RuntimeInterface.AddDOMHandlerClass(e)}{function e(e,t){return e.length===t.length&&(e===t||e.toLowerCase()===t.toLowerCase())}const t=class extends DOMHandler{constructor(e){super(e,"audio"),this._audioContext=null,this._destinationNode=null,this._hasUnblocked=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTag="",this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._playMusicAsSound=!1,this._hasAnySoftwareDecodedMusic=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(e,t)=>this._OnMicrophoneStream(e,t),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),this.AddRuntimeMessageHandlers([["create-audio-context",e=>this._CreateAudioContext(e)],["play",e=>this._Play(e)],["stop",e=>this._Stop(e)],["stop-all",()=>this._StopAll()],["set-paused",e=>this._SetPaused(e)],["set-volume",e=>this._SetVolume(e)],["fade-volume",e=>this._FadeVolume(e)],["set-master-volume",e=>this._SetMasterVolume(e)],["set-muted",e=>this._SetMuted(e)],["set-silent",e=>this._SetSilent(e)],["set-looping",e=>this._SetLooping(e)],["set-playback-rate",e=>this._SetPlaybackRate(e)],["seek",e=>this._Seek(e)],["preload",e=>this._Preload(e)],["unload",e=>this._Unload(e)],["unload-all",()=>this._UnloadAll()],["set-suspended",e=>this._SetSuspended(e)],["add-effect",e=>this._AddEffect(e)],["set-effect-param",e=>this._SetEffectParam(e)],["remove-effects",e=>this._RemoveEffects(e)],["tick",e=>this._OnTick(e)],["load-state",e=>this._OnLoadState(e)]])}async _CreateAudioContext(e){e.isWKWebView&&(this._playMusicAsSound=!0),this._timeScaleMode=e.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][e.panningModel],this._distanceModel=["linear","inverse","exponential"][e.distanceModel],this._refDistance=e.refDistance,this._maxDistance=e.maxDistance,this._rolloffFactor=e.rolloffFactor;const t={latencyHint:e.latencyHint};if("undefined"!=typeof AudioContext)this._audioContext=new AudioContext(t);else if("undefined"!=typeof webkitAudioContext)this._audioContext=new webkitAudioContext(t);else throw new Error("Web Audio API not supported");this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination);const n=e.listenerPos;this._audioContext.listener.setPosition(n[0],n[1],n[2]),this._audioContext.listener.setOrientation(0,0,1,0,-1,0),window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(e.preloadList.map(e=>this._GetAudioBuffer(e.originalUrl,e.url,e.type,!1)))}catch(e){console.error("[Construct 3] Preloading sounds failed: ",e)}return{sampleRate:this._audioContext.sampleRate}}_UnblockAudioContext(){if(!this._hasUnblocked){const e=this._audioContext;"suspended"===e.state&&e.resume&&e.resume();const t=e.createBuffer(1,220,22050),n=e.createBufferSource();n.buffer=t,n.connect(e.destination),n.start(0),"running"===e.state&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._unblockFunc=null)}}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetDestinationForTag(e){const t=this._effects.get(e.toLowerCase());return t?t[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(e,t){e=e.toLowerCase();let n=this._effects.get(e);n||(n=[],this._effects.set(e,n)),t._SetIndex(n.length),t._SetTag(e),n.push(t),this._ReconnectEffects(e)}_ReconnectEffects(e){let t=this.GetDestinationNode();const n=this._effects.get(e);if(n&&n.length){t=n[0].GetInputNode();for(let e=0,t=n.length;e<t;++e){const o=n[e];e+1===t?o.ConnectTo(this.GetDestinationNode()):o.ConnectTo(n[e+1].GetInputNode())}}for(const n of this.audioInstancesByTag(e))n.Reconnect(t);this._microphoneSource&&this._microphoneTag===e&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(t))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(e,t){return t?this._iRuntime._WasmDecodeWebMOpus(e).then(e=>{const t=this._audioContext.createBuffer(1,e.length,48e3),n=t.getChannelData(0);return n.set(e),t}):new Promise((t,n)=>{this._audioContext.decodeAudioData(e,t,n)})}TryPlayMedia(e){this._iRuntime.TryPlayMedia(e)}RemovePendingPlay(e){this._iRuntime.RemovePendingPlay(e)}ReleaseInstancesForBuffer(t){let n=0;for(let o=0,e=this._audioInstances.length;o<e;++o){const a=this._audioInstances[o];this._audioInstances[n]=a,a.GetBuffer()===t?a.Release():++n}this._audioInstances.length=n}ReleaseAllMusicBuffers(){let e=0;for(let t=0,n=this._audioBuffers.length;t<n;++t){const n=this._audioBuffers[t];this._audioBuffers[e]=n,n.IsMusic()?n.Release():++e}this._audioBuffers.length=e}*audioInstancesByTag(t){if(t)for(const n of this._audioInstances)e(n.GetTag(),t)&&(yield n);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(t,n,o,a,i){for(const e of this._audioBuffers)if(e.GetUrl()===n)return await e.Load(),e;if(i)return null;a&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();const e=C3AudioBuffer.Create(this,t,n,o,a);return this._audioBuffers.push(e),await e.Load(),e}async _GetAudioInstance(t,n,o,a,i){for(const e of this._audioInstances)if(e.GetUrl()===n&&(e.CanBeRecycled()||i))return e.SetTag(a),e;const e=await this._GetAudioBuffer(t,n,o,i),d=e.CreateInstance(a);return this._audioInstances.push(d),d}_AddPendingTag(e){let t=this._pendingTags.get(e);if(!t){let n=null;const o=new Promise(e=>n=e);t={pendingCount:0,promise:o,resolve:n},this._pendingTags.set(e,t)}t.pendingCount++}_RemovePendingTag(e){const t=this._pendingTags.get(e);if(!t)throw new Error("expected pending tag");t.pendingCount--,0===t.pendingCount&&(t.resolve(),this._pendingTags.delete(e))}TagReady(e){e||(e=this._lastPlayedTag);const t=this._pendingTags.get(e);return t?t.promise:Promise.resolve()}_MaybeStartTicking(){if(0<this._analysers.size)return void this._StartTicking();for(const e of this._audioInstances)if(e.IsActive())return void this._StartTicking()}Tick(){for(const e of this._analysers)e.Tick();const e=this.GetAudioCurrentTime();for(const t of this._audioInstances)t.Tick(e);const t=this._audioInstances.filter(e=>e.IsActive()).map(e=>e.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,audioInstances:t,analysers:[...this._analysers].map(e=>e.GetData())}),0===t.length&&0===this._analysers.size&&this._StopTicking()}PostTrigger(e,t){this.PostToRuntime("trigger",{type:e,tag:t})}async _Play(t){const n=t.originalUrl,o=t.url,a=t.type,d=t.isMusic,e=t.tag,r=t.isLooping,s=t.vol,u=t.pos,i=t.panning;let _=t.off;if(0<_&&!t.trueClock)if(this._audioContext.getOutputTimestamp){const e=this._audioContext.getOutputTimestamp();_=_-e.performanceTime/1e3+e.contextTime}else _=_-performance.now()/1e3+this._audioContext.currentTime;this._lastPlayedTag=e,this._AddPendingTag(e);try{this._lastAudioInstance=await this._GetAudioInstance(n,o,a,e,d),i?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(i.x,i.y,i.angle,i.innerAngle,i.outerAngle,i.outerGain),i.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(i.uid)):this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.Play(r,s,u,_)}catch(e){return void console.error("[Construct 3] Audio: error starting playback: ",e)}finally{this._RemovePendingTag(e)}this._StartTicking()}_Stop(e){const t=e.tag;for(const n of this.audioInstancesByTag(t))n.Stop()}_StopAll(){for(const e of this._audioInstances)e.Stop()}_SetPaused(e){const t=e.tag,n=e.paused;for(const o of this.audioInstancesByTag(t))n?o.Pause():o.Resume();this._MaybeStartTicking()}_SetVolume(e){const t=e.tag,n=e.vol;for(const o of this.audioInstancesByTag(t))o.SetVolume(n)}async _FadeVolume(t){const n=t.tag,o=t.vol,a=t.duration,i=t.stopOnEnd;await this.TagReady(n);for(const e of this.audioInstancesByTag(n))e.FadeVolume(o,a,i);this._MaybeStartTicking()}_SetMasterVolume(e){this._masterVolume=e.vol;for(const t of this._audioInstances)t._UpdateVolume()}_SetMuted(e){const t=e.tag,n=e.isMuted;for(const o of this.audioInstancesByTag(t))o.SetMuted(n)}_SetSilent(e){this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const t of this._audioInstances)t._UpdateMuted()}_SetLooping(e){const t=e.tag,n=e.isLooping;for(const o of this.audioInstancesByTag(t))o.SetLooping(n)}_SetPlaybackRate(e){const t=e.tag,n=e.rate;for(const o of this.audioInstancesByTag(t))o.SetPlaybackRate(n)}_Seek(e){const t=e.tag,n=e.pos;for(const o of this.audioInstancesByTag(t))o.Seek(n)}async _Preload(t){const n=t.originalUrl,o=t.url,a=t.type,i=t.isMusic;try{await this._GetAudioInstance(n,o,a,"",i)}catch(e){console.error("[Construct 3] Audio: error preloading: ",e)}}async _Unload(t){const n=t.url,o=t.type,a=t.isMusic,i=await this._GetAudioBuffer("",n,o,a,!0);if(i){i.Release();const e=this._audioBuffers.indexOf(i);-1!==e&&this._audioBuffers.splice(e,1)}}_UnloadAll(){for(const e of this._audioBuffers)e.Release();this._audioBuffers.length=0}_SetSuspended(e){const t=e.isSuspended;!t&&this._audioContext.resume&&this._audioContext.resume();for(const n of this._audioInstances)n.SetSuspended(t);t&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(e){if(this._timeScale=e.timeScale,this._gameTime=e.gameTime,this._lastTickCount=e.tickCount,0!==this._timeScaleMode)for(const e of this._audioInstances)e._UpdatePlaybackRate();const t=e.listenerPos;t&&this._audioContext.listener.setPosition(t[0],t[1],t[2]);for(const t of e.instPans){const e=t.uid;for(const n of this._audioInstances)n.GetUID()===e&&n.SetPanXYA(t.x,t.y,t.angle)}}async _AddEffect(t){const n=t.type,o=t.tag,a=t.params;let i;if("filter"===n)i=new C3AudioFilterFX(this,...a);else if("delay"===n)i=new C3AudioDelayFX(this,...a);else if("convolution"===n){let e=null;try{e=await this._GetAudioBuffer(t.bufferOriginalUrl,t.bufferUrl,t.bufferType,!1)}catch(e){return void console.log("[Construct 3] Audio: error loading convolution: ",e)}i=new C3AudioConvolveFX(this,e.GetAudioBuffer(),...a),i._SetBufferInfo(t.bufferOriginalUrl,t.bufferUrl,t.bufferType)}else if("flanger"===n)i=new C3AudioFlangerFX(this,...a);else if("phaser"===n)i=new C3AudioPhaserFX(this,...a);else if("gain"===n)i=new C3AudioGainFX(this,...a);else if("tremolo"===n)i=new C3AudioTremoloFX(this,...a);else if("ringmod"===n)i=new C3AudioRingModFX(this,...a);else if("distortion"===n)i=new C3AudioDistortionFX(this,...a);else if("compressor"===n)i=new C3AudioCompressorFX(this,...a);else if("analyser"===n)i=new C3AudioAnalyserFX(this,...a);else throw new Error("invalid effect type");this.AddEffectForTag(o,i),this._PostUpdatedFxState()}_SetEffectParam(t){const n=t.tag,o=t.index,a=t.param,i=t.value,e=t.ramp,d=t.time,r=this._effects.get(n);!r||0>o||o>=r.length||(r[o].SetParam(a,i,e,d),this._PostUpdatedFxState())}_RemoveEffects(e){const t=e.tag.toLowerCase(),n=this._effects.get(t);if(n&&n.length){for(const e of n)e.Release();this._effects.delete(t),this._ReconnectEffects(t)}}_AddAnalyser(e){this._analysers.add(e),this._MaybeStartTicking()}_RemoveAnalyser(e){this._analysers.delete(e)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const e={};for(const[t,n]of this._effects)e[t]=n.map(e=>e.GetState());this.PostToRuntime("fxstate",{fxstate:e}),this._isPendingPostFxState=!1}async _OnLoadState(e){const t=e.saveLoadMode;if(3!==t)for(const e of this._audioInstances)e.IsMusic()&&1===t||!e.IsMusic()&&2===t||e.Stop();for(const t of this._effects.values())for(const e of t)e.Release();this._effects.clear(),this._timeScale=e.timeScale,this._gameTime=e.gameTime;const n=e.listenerPos;this._audioContext.listener.setPosition(n[0],n[1],n[2]),this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=e.masterVolume;const o=[];for(const t of Object.values(e.effects))o.push(Promise.all(t.map(e=>this._AddEffect(e))));await Promise.all(o),await Promise.all(e.playing.map(e=>this._LoadAudioInstance(e,t))),this._MaybeStartTicking()}async _LoadAudioInstance(t,n){if(3===n)return;const o=t.bufferOriginalUrl,a=t.bufferUrl,d=t.bufferType,e=t.isMusic,r=t.tag,s=t.isLooping,u=t.volume,i=t.playbackTime;if(e&&1===n)return;if(!e&&2===n)return;let _=null;try{_=await this._GetAudioInstance(o,a,d,r,e)}catch(e){return void console.error("[Construct 3] Audio: error loading audio state: ",e)}_.LoadPanState(t.pan),_.Play(s,u,i,0),t.isPlaying||_.Pause(),_._LoadAdditionalState(t)}_OnMicrophoneStream(e,t){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=t.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(e),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}};RuntimeInterface.AddDOMHandlerClass(t)}"use strict",self.C3AudioBuffer=class{constructor(t,n,o,a,i){this._audioDomHandler=t,this._originalUrl=n,this._url=o,this._type=a,this._isMusic=i,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}static Create(t,n,o,a,i){const e="audio/webm; codecs=opus"===a&&!t.SupportsWebMOpus();return i&&e&&t._SetHasAnySoftwareDecodedMusic(),!i||t.IsPlayMusicAsSound()||e?new C3WebAudioBuffer(t,n,o,a,i,e):new C3Html5AudioBuffer(t,n,o,a,i)}CreateInstance(e){return"html5"===this._api?new C3Html5AudioInstance(this._audioDomHandler,this,e):new C3WebAudioInstance(this._audioDomHandler,this,e)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return"failed"===this._loadState}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}},"use strict",self.C3Html5AudioBuffer=class extends C3AudioBuffer{constructor(t,n,o,a,i){super(t,n,o,a,i),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null),this._mediaSourceNode||!this._audioElem||(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",e=>this._OnError(e))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((e,t)=>{this._loadResolve=e,this._loadReject=t,this._audioElem.src=this._url})}_OnError(e){console.error(`[Construct 3] Audio '${this._url}' error: `,e),this._loadReject&&(this._loadState="failed",this._loadReject(e),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const e=4<=this._audioElem.readyState;return e&&(this._reachedCanPlayThrough=!0),e||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}},"use strict",self.C3WebAudioBuffer=class extends C3AudioBuffer{constructor(t,n,o,a,i,e){super(t,n,o,a,i),this._api="webaudio",this._audioData=null,this._audioBuffer=null,this._needsSoftwareDecode=!!e}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const e=this._audioDomHandler.GetRuntimeInterface();if("cordova"===e.GetExportType()&&e.IsRelativeURL(this._url))this._audioData=await e.CordovaFetchLocalFileAsArrayBuffer(this._url);else{const e=await fetch(this._url);if(!e.ok)throw new Error(`error fetching audio data: ${e.status} ${e.statusText}`);this._audioData=await e.arrayBuffer()}}async _Decode(){return this._audioBuffer?this._audioBuffer:void(this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null)}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(e){this._loadState="failed",console.error(`[Construct 3] Failed to load audio '${this._url}': `,e)}}IsLoaded(){return!!(this._audioData||this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}},"use strict";{function t(t){return t*e}const e=180/Math.PI;self.C3AudioInstance=class{constructor(e,t,n){this._audioDomHandler=e,this._buffer=t,this._tag=n,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const o=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=1===o&&!this.IsMusic()||2===o,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this._tag)}GetMasterVolume(){return this._audioDomHandler.GetMasterVolume()}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}SetTag(e){this._tag=e}GetTag(){return this._tag}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(e){let t=this._buffer.GetDuration();return e&&(t/=this._playbackRate||.001),t}Play(){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(e){this._volume=e,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOverallVolume()}FadeVolume(t,n,o){if(!this.IsMuted()){t*=this.GetMasterVolume();const a=this._gainNode.gain;a.cancelScheduledValues(0);const i=this._audioDomHandler.GetAudioCurrentTime(),e=i+n;a.setValueAtTime(this.GetOverallVolume(),i),a.linearRampToValueAtTime(t,e),this._volume=t,this._fadeEndTime=e,this._stopOnFadeEnd=o}}_UpdateVolume(){this.SetVolume(this._volume)}Tick(e){-1!==this._fadeEndTime&&e>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tag))}GetOverallVolume(){const e=this._volume*this.GetMasterVolume();return isFinite(e)?e:0}SetMuted(e){e=!!e,this._isMuted===e||(this._isMuted=e,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(){}IsLooping(){return this._isLooping}SetPlaybackRate(e){this._playbackRate===e||(this._playbackRate=e,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(){}SetSuspended(){}SetPannerEnabled(e){e=!!e,this._isPannerEnabled===e||(this._isPannerEnabled=e,this._isPannerEnabled?(!this._pannerNode&&(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(n,o,a,i,e,d){this._isPannerEnabled&&(this.SetPanXYA(n,o,a),this._pannerNode.coneInnerAngle=t(i),this._pannerNode.coneOuterAngle=t(e),this._pannerNode.coneOuterGain=d)}SetPanXYA(e,t,n){this._isPannerEnabled&&(this._pannerNode.setPosition(e,t,0),this._pannerNode.setOrientation(Math.cos(n),Math.sin(n),0))}SetUID(e){this._instUid=e}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(e){const t=this._pannerNode||this._gainNode;t.disconnect(),t.connect(e)}GetState(){return{tag:this._tag,duration:this.GetDuration(),volume:this._volume,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState()}}_LoadAdditionalState(e){this.SetPlaybackRate(e.playbackRate),this.SetMuted(e.isMuted)}GetPanState(){if(!this._pannerNode)return null;const e=this._pannerNode;return{pos:[e.positionX.value,e.positionY.value,e.positionZ.value],orient:[e.orientationX.value,e.orientationY.value,e.orientationZ.value],cia:e.coneInnerAngle,coa:e.coneOuterAngle,cog:e.coneOuterGain,uid:this._instUid}}LoadPanState(e){if(!e)return void this.SetPannerEnabled(!1);this.SetPannerEnabled(!0);const t=this._pannerNode;t.setPosition(...t.pos),t.setOrientation(...t.orient),t.coneInnerAngle=t.cia,t.coneOuterAngle=t.coa,t.coneOuterGain=t.cog,this._instUid=t.uid}}}"use strict",self.C3Html5AudioInstance=class extends C3AudioInstance{constructor(e,t,n){super(e,t,n),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tag)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return!!this._isStopped||this.HasEnded()}GetPlaybackTime(e){let t=this.GetAudioElement().currentTime;return e&&(t*=this._playbackRate),this._isLooping||(t=Math.min(t,this.GetDuration())),t}Play(e,t,n){const o=this.GetAudioElement();if(1!==o.playbackRate&&(o.playbackRate=1),o.loop!==e&&(o.loop=e),this.SetVolume(t),o.muted&&(o.muted=!1),o.currentTime!==n)try{o.currentTime=n}catch(e){console.warn(`[Construct 3] Exception seeking audio '${this._buffer.GetUrl()}' to position '${n}': `,e)}this._audioDomHandler.TryPlayMedia(o),this._isStopped=!1,this._isPaused=!1,this._isLooping=e,this._playbackRate=1}Stop(){const e=this.GetAudioElement();e.paused||e.pause(),this._audioDomHandler.RemovePendingPlay(e),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(!(this._isPaused||this._isStopped||this.HasEnded())){const e=this.GetAudioElement();e.paused||e.pause(),this._audioDomHandler.RemovePendingPlay(e),this._isPaused=!0}}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(e){e=!!e,this._isLooping===e||(this._isLooping=e,this.GetAudioElement().loop=e)}_UpdatePlaybackRate(){let e=this._playbackRate;this._isTimescaled&&(e*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=e}catch(t){console.warn(`[Construct 3] Unable to set playback rate '${e}':`,t)}}Seek(e){if(!(this._isStopped||this.HasEnded()))try{this.GetAudioElement().currentTime=e}catch(t){console.warn(`[Construct 3] Error seeking audio to '${e}': `,t)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(e){e?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}},"use strict",self.C3WebAudioInstance=class extends C3AudioInstance{constructor(e,t,n){super(e,t,n),this._bufferSource=null,this._onended_handler=e=>this._OnEnded(e),this._hasPlaybackEnded=!0,this._activeSource=null,this._startTime=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&this._bufferSource.disconnect(),this._bufferSource=null,this._activeSource=null}_OnEnded(e){this._isPaused||this._resumeMe||e.target!==this._activeSource||(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tag))}HasEnded(){return!(!this._isStopped&&this._bufferSource&&this._bufferSource.loop)&&!this._isPaused&&this._hasPlaybackEnded}CanBeRecycled(){return!this._bufferSource||this._isStopped||this.HasEnded()}GetPlaybackTime(e){let t=0;return t=this._isPaused?this._resumePosition:this.GetCurrentTime()-this._startTime,e&&(t*=this._playbackRate),this._isLooping||(t=Math.min(t,this.GetDuration())),t}Play(e,t,n,o){this._muteVol=1,this.SetVolume(t),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=e,this._bufferSource.start(o,n),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=e,this._playbackRate=1,this._startTime=this.GetCurrentTime()-n}Stop(){this._bufferSource&&this._bufferSource.stop(0),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(!0),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._startTime=this.GetCurrentTime()-this._resumePosition/(this._playbackRate||.001),this._bufferSource.start(0,this._resumePosition),this._isPaused=!1)}GetOverallVolume(){return super.GetOverallVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(e){e=!!e,this._isLooping===e||(this._isLooping=e,this._bufferSource&&(this._bufferSource.loop=e))}_UpdatePlaybackRate(){let e=this._playbackRate;this._isTimescaled&&(e*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=e)}Seek(e){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=e:(this.Pause(),this._resumePosition=e,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(e){e?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(!0),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._startTime=this.GetCurrentTime()-this._resumePosition/(this._playbackRate||.001),this._bufferSource.start(0,this._resumePosition),this._resumeMe=!1)}_LoadAdditionalState(e){super._LoadAdditionalState(e),this._resumePosition=e.resumePosition}},"use strict";{function t(e){return Math.pow(10,e/20)}function n(e){return Math.max(Math.min(t(e),1),0)}function o(e){return 20*(Math.log(e)/2.302585092994046)}function i(e){return o(Math.max(Math.min(e,1),0))}function r(e,t){return 1-Math.exp(-t*e)}class e{constructor(e){this._audioDomHandler=e,this._audioContext=e.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(e){this._index=e}GetIndex(){return this._index}_SetTag(e){this._tag=e}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(){}SetAudioParam(t,n,o,a){if(t.cancelScheduledValues(0),0===a)return void(t.value=n);const i=this._audioContext.currentTime;a+=i,0===o?t.setValueAtTime(n,a):1===o?(t.setValueAtTime(t.value,i),t.linearRampToValueAtTime(n,a)):2===o?(t.setValueAtTime(t.value,i),t.exponentialRampToValueAtTime(n,a)):void 0}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends e{constructor(t,n,o,a,i,e,d){super(t),this._type="filter",this._params=[n,o,a,i,e,d],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=d,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-d,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=n,this._filterNode.frequency.value=o,this._filterNode.detune.value=a,this._filterNode.Q.value=i,this._filterNode.gain.vlaue=e,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[5]=t,this.SetAudioParam(this._wetNode.gain,t,n,o),this.SetAudioParam(this._dryNode.gain,1-t,n,o)):1===e?(this._params[1]=t,this.SetAudioParam(this._filterNode.frequency,t,n,o)):2===e?(this._params[2]=t,this.SetAudioParam(this._filterNode.detune,t,n,o)):3===e?(this._params[3]=t,this.SetAudioParam(this._filterNode.Q,t,n,o)):4===e?(this._params[4]=t,this.SetAudioParam(this._filterNode.gain,t,n,o)):void 0}},self.C3AudioDelayFX=class extends e{constructor(e,t,n,o){super(e),this._type="delay",this._params=[t,n,o],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=o,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(t),this._delayNode.delayTime.value=t,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=n,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(t,o,a,i){0===t?(o=Math.max(Math.min(o/100,1),0),this._params[2]=o,this.SetAudioParam(this._wetNode.gain,o,a,i),this.SetAudioParam(this._dryNode.gain,1-o,a,i)):4===t?(this._params[1]=n(o),this.SetAudioParam(this._delayGainNode.gain,n(o),a,i)):5===t?(this._params[0]=o,this.SetAudioParam(this._delayNode.delayTime,o,a,i)):void 0}},self.C3AudioConvolveFX=class extends e{constructor(e,t,n,o){super(e),this._type="convolution",this._params=[n,o],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=o,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=n,this._convolveNode.buffer=t,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._wetNode.gain,t,n,o),this.SetAudioParam(this._dryNode.gain,1-t,n,o)):void 0}_SetBufferInfo(e,t,n){this._bufferOriginalUrl=e,this._bufferUrl=t,this._bufferType=n}GetState(){const e=super.GetState();return e.bufferOriginalUrl=this._bufferOriginalUrl,e.bufferUrl="",e.bufferType=this._bufferType,e}},self.C3AudioFlangerFX=class extends e{constructor(t,n,o,a,i,e){super(t),this._type="flanger",this._params=[n,o,a,i,e],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-e/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=e/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=i,this._delayNode=this._audioContext.createDelay(n+o),this._delayNode.delayTime.value=n,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=a,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=o,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[4]=t,this.SetAudioParam(this._wetNode.gain,t/2,n,o),this.SetAudioParam(this._dryNode.gain,1-t/2,n,o)):6===e?(this._params[1]=t/1e3,this.SetAudioParam(this._oscGainNode.gain,t/1e3,n,o)):7===e?(this._params[2]=t,this.SetAudioParam(this._oscNode.frequency,t,n,o)):8===e?(this._params[3]=t/100,this.SetAudioParam(this._feedbackNode.gain,t/100,n,o)):void 0}},self.C3AudioPhaserFX=class extends e{constructor(t,n,o,a,i,e,d){super(t),this._type="phaser",this._params=[n,o,a,i,e,d],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-d/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=d/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=n,this._filterNode.detune.value=o,this._filterNode.Q.value=a,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=e,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[5]=t,this.SetAudioParam(this._wetNode.gain,t/2,n,o),this.SetAudioParam(this._dryNode.gain,1-t/2,n,o)):1===e?(this._params[0]=t,this.SetAudioParam(this._filterNode.frequency,t,n,o)):2===e?(this._params[1]=t,this.SetAudioParam(this._filterNode.detune,t,n,o)):3===e?(this._params[2]=t,this.SetAudioParam(this._filterNode.Q,t,n,o)):6===e?(this._params[3]=t,this.SetAudioParam(this._oscGainNode.gain,t,n,o)):7===e?(this._params[4]=t,this.SetAudioParam(this._oscNode.frequency,t,n,o)):void 0}},self.C3AudioGainFX=class extends e{constructor(e,t){super(e),this._type="gain",this._params=[t],this._node=this.CreateGain(),this._node.gain.value=t}Release(){this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(t,o,a,i){4===t?(this._params[0]=n(o),this.SetAudioParam(this._node.gain,n(o),a,i)):void 0}},self.C3AudioTremoloFX=class extends e{constructor(e,t,n){super(e),this._type="tremolo",this._params=[t,n],this._node=this.CreateGain(),this._node.gain.value=1-n/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=t,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=n/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._node.gain.value,1-t/2,n,o),this.SetAudioParam(this._oscGainNode.gain.value,t/2,n,o)):7===e?(this._params[0]=t,this.SetAudioParam(this._oscNode.frequency,t,n,o)):void 0}},self.C3AudioRingModFX=class extends e{constructor(e,t,n){super(e),this._type="ringmod",this._params=[t,n],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=n,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-n,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=t,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._wetNode.gain,t,n,o),this.SetAudioParam(this._dryNode.gain,1-t,n,o)):7===e?(this._params[0]=t,this.SetAudioParam(this._oscNode.frequency,t,n,o)):void 0}},self.C3AudioDistortionFX=class extends e{constructor(t,n,o,a,i,e){super(t),this._type="distortion",this._params=[n,o,a,i,e],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(a,i),this._wetNode=this.CreateGain(),this._wetNode.gain.value=e,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-e,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(n,o),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(e,t){.01>e&&(e=.01),this._preGain.gain.value=e,this._postGain.gain.value=Math.pow(1/e,.6)*t}_GenerateColortouchCurve(e,t){for(let n,o=0;32768>o;++o)n=o/32768,n=this._Shape(n,e,t),this._curve[32768+o]=n,this._curve[32768-o-1]=-n}_Shape(e,t,n){const o=1.05*n*t-t,a=0>e?-1:1,i=0>e?-e:e;let d=i<t?i:t+o*r(i-t,1/o);return d*=a,d}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,n,o){0===e?(t=Math.max(Math.min(t/100,1),0),this._params[4]=t,this.SetAudioParam(this._wetNode.gain,t,n,o),this.SetAudioParam(this._dryNode.gain,1-t,n,o)):void 0}},self.C3AudioCompressorFX=class extends e{constructor(t,n,o,a,i,e){super(t),this._type="compressor",this._params=[n,o,a,i,e],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=n,this._node.knee.value=o,this._node.ratio.value=a,this._node.attack.value=i,this._node.release.value=e}Release(){this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(){}},self.C3AudioAnalyserFX=class extends e{constructor(e,t,n){super(e),this._type="analyser",this._params=[t,n],this._node=this._audioContext.createAnalyser(),this._node.fftSize=t,this._node.smoothingTimeConstant=n,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(t),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const e=this._node.fftSize;this._peak=0;let t=0;for(let n,o=0;o<e;++o)n=(this._signal[o]-128)/128,0>n&&(n=-n),this._peak<n&&(this._peak=n),t+=n*n;this._peak=i(this._peak),this._rms=i(Math.sqrt(t/e))}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}{const e=class extends DOMHandler{constructor(e){super(e,"mouse"),this.AddRuntimeMessageHandler("cursor",e=>this._OnChangeCursorStyle(e))}_OnChangeCursorStyle(e){document.body.style.cursor=e}};RuntimeInterface.AddDOMHandlerClass(e)}{let e=!1;const t=class extends DOMHandler{constructor(e){super(e,"advert");const t=e=>[e,t=>this._CallMethod(e,t)];this.AddRuntimeMessageHandlers([t("CreateBannerAdvert"),t("ShowBannerAdvert"),t("HideBannerAdvert"),t("CreateInterstitialAdvert"),t("ShowInterstitialAdvert"),t("CreateVideoAdvert"),t("ShowVideoAdvert"),t("Configure"),t("RequestConsent"),t("SetUserPersonalisation")])}_GetPlugin(){return window.cordova&&window.cordova.plugins.ConstructAd}async _CallMethod(t,n){const o=this._GetPlugin();if(!o)throw e||(e=!0,console.warn("The Mobile Advert plugin is not loaded. Please note that it only works in Android or iOS exports")),new Error("advert plugin not loaded");return new Promise((i,a)=>{o[t](...n,(e,t)=>{e?a(e):i(t)})})}};RuntimeInterface.AddDOMHandlerClass(t)}